name: Weekly Data Update

on:
  schedule:
    # 毎週金曜日 20:00 UTC (日本時間 土曜日 05:00)
    - cron: '0 20 * * 5'
  workflow_dispatch:  # 手動実行も可能

permissions:
  contents: write

jobs:
  update-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6時間（全件取得の場合）
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev  # devブランチから実行

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Download previous data
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== 前回データをダウンロード ==="
          mkdir -p output/data
          
          # 最新リリースのタグを取得
          LATEST_TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "❌ エラー: 前回リリースが見つかりません"
            echo "初回データを手動でアップロードしてください"
            exit 1
          fi
          
          echo "前回リリース: ${LATEST_TAG}"
          
          # 最新リリースから前回データをダウンロード
          gh release download "${LATEST_TAG}" --pattern "ygo-data-*.tar.gz" --dir . --clobber
          tar -xzf ygo-data-*.tar.gz -C output/data/
          echo "✓ 前回データを展開しました"
          ls -lh output/data/

      - name: Install dependencies
        run: bun install

      - name: Run data update (incremental)
        run: |
          echo "=== 増分データ更新開始 ==="
          bun run update:all
          echo "=== 増分データ更新完了 ==="

      - name: Check data files
        run: |
          ls -lh output/data/
          echo "Cards: $(wc -l < output/data/cards-all.tsv) lines"
          echo "Details: $(wc -l < output/data/detail-all.tsv) lines"
          echo "FAQ: $(wc -l < output/data/faq-all.tsv) lines"

      - name: Create archives
        run: |
          DATE=$(date -u +%Y.%m.%d)
          TAR_GZ_NAME="ygo-data-${DATE}.tar.gz"
          ZIP_NAME="ygo-data-${DATE}.zip"
          echo "TAR_GZ_NAME=${TAR_GZ_NAME}" >> $GITHUB_ENV
          echo "ZIP_NAME=${ZIP_NAME}" >> $GITHUB_ENV
          echo "RELEASE_TAG=${DATE}" >> $GITHUB_ENV

          cd output/data

          # Create tar.gz archive
          tar -czf ../../${TAR_GZ_NAME} *.tsv

          # Create zip archive
          zip -q ../../${ZIP_NAME} *.tsv

          cd ../..

          echo "=== アーカイブ作成完了 ==="
          ls -lh ${TAR_GZ_NAME} ${ZIP_NAME}

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # リリースノートを生成
          cat > release-notes.md << EOF
          ## Data Statistics

          Updated at: $(date '+%Y-%m-%d %H:%M:%S UTC')

          ### Data Counts
          - cards-all.tsv: $(wc -l < output/data/cards-all.tsv | xargs) lines
          - detail-all.tsv: $(wc -l < output/data/detail-all.tsv | xargs) lines
          - faq-all.tsv: $(wc -l < output/data/faq-all.tsv | xargs) lines

          ### File Contents
          - \`cards-all.tsv\`: Card information (name, type, attribute, attack power, etc.)
          - \`detail-all.tsv\`: Card supplementary information (rule notes, pendulum notes)
          - \`faq-all.tsv\`: FAQ details (questions, answers, update dates)

          ### Data Format
          - Encoding: UTF-8
          - Delimiter: Tab (TSV)
          - Sort order: ID descending (newest first)
          EOF
          
          # 既存のリリースがあるか確認
          if gh release view "${RELEASE_TAG}" 2>/dev/null; then
            echo "既存のリリースを更新します: ${RELEASE_TAG}"
            # 既存のアセットを削除
            gh release delete-asset "${RELEASE_TAG}" "ygo-data-${RELEASE_TAG}.tar.gz" 2>/dev/null || true
            gh release delete-asset "${RELEASE_TAG}" "ygo-data-${RELEASE_TAG}.zip" 2>/dev/null || true
            # 新しいアセットをアップロード
            gh release upload "${RELEASE_TAG}" "${TAR_GZ_NAME}" "${ZIP_NAME}"
          else
            echo "新しいリリースを作成します: ${RELEASE_TAG}"
            # リリース作成
            gh release create "${RELEASE_TAG}" \
              "${TAR_GZ_NAME}" "${ZIP_NAME}" \
              --title "Neuron Data on ${RELEASE_TAG}" \
              --notes-file release-notes.md
          fi

      - name: Keep only latest 3 releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== 古いリリースを削除 ==="
          
          # リリースタグを取得（新しい順）
          RELEASES=$(gh release list --limit 100 --json tagName -q '.[].tagName')
          
          # 配列に変換
          readarray -t RELEASE_ARRAY <<< "$RELEASES"
          
          # 件数確認
          TOTAL=${#RELEASE_ARRAY[@]}
          echo "総リリース数: ${TOTAL}"
          
          # 4番目以降を削除
          if [ ${TOTAL} -gt 3 ]; then
            echo "最新3件を保持し、残りを削除します"
            for i in $(seq 3 $((TOTAL-1))); do
              TAG="${RELEASE_ARRAY[$i]}"
              if [ -n "$TAG" ]; then
                echo "削除中: ${TAG}"
                gh release delete "${TAG}" --yes --cleanup-tag || true
              fi
            done
          else
            echo "リリース数が3件以下のため、削除不要です"
          fi

      - name: Summary
        run: |
          echo "## ✅ データ更新完了" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **リリースタグ**: ${RELEASE_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "- **tar.gz**: ${TAR_GZ_NAME} ($(ls -lh ${TAR_GZ_NAME} | awk '{print $5}'))" >> $GITHUB_STEP_SUMMARY
          echo "- **zip**: ${ZIP_NAME} ($(ls -lh ${ZIP_NAME} | awk '{print $5}'))" >> $GITHUB_STEP_SUMMARY
