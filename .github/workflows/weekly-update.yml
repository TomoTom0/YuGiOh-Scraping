name: Weekly Data Update

on:
  schedule:
    # æ¯é€±é‡‘æ›œæ—¥ 20:00 UTC (æ—¥æœ¬æ™‚é–“ åœŸæ›œæ—¥ 05:00)
    - cron: '0 20 * * 5'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

permissions:
  contents: write

jobs:
  update-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6æ™‚é–“ï¼ˆå…¨ä»¶å–å¾—ã®å ´åˆï¼‰
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: dev  # devãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰å®Ÿè¡Œ

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Download previous data
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== å‰å›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ==="
          mkdir -p output/data
          
          # æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã®ã‚¿ã‚°ã‚’å–å¾—
          LATEST_TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName')
          
          if [ -z "$LATEST_TAG" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: å‰å›ãƒªãƒªãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "åˆå›ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„"
            exit 1
          fi
          
          echo "å‰å›ãƒªãƒªãƒ¼ã‚¹: ${LATEST_TAG}"
          
          # æœ€æ–°ãƒªãƒªãƒ¼ã‚¹ã‹ã‚‰å‰å›ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          gh release download "${LATEST_TAG}" --pattern "ygo-data-*.tar.gz" --dir . --clobber
          tar -xzf ygo-data-*.tar.gz -C output/data/
          echo "âœ“ å‰å›ãƒ‡ãƒ¼ã‚¿ã‚’å±•é–‹ã—ã¾ã—ãŸ"
          ls -lh output/data/

      - name: Install dependencies
        run: bun install

      - name: Run data update (incremental)
        run: |
          echo "=== å¢—åˆ†ãƒ‡ãƒ¼ã‚¿æ›´æ–°é–‹å§‹ ==="
          bun run update:all
          echo "=== å¢—åˆ†ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº† ==="

      - name: Check data files
        run: |
          ls -lh output/data/
          echo "Cards: $(wc -l < output/data/cards-all.tsv) lines"
          echo "Details: $(wc -l < output/data/details-all.tsv) lines"
          echo "FAQ: $(wc -l < output/data/faq-all.tsv) lines"

      - name: Create archive
        run: |
          DATE=$(date -u +%Y.%m.%d)
          ARCHIVE_NAME="ygo-data-${DATE}.tar.gz"
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV
          echo "RELEASE_TAG=${DATE}" >> $GITHUB_ENV
          
          cd output/data
          tar -czf ../../${ARCHIVE_NAME} *.tsv
          cd ../..
          
          echo "=== ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆå®Œäº† ==="
          ls -lh ${ARCHIVE_NAME}

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          cat > release-notes.md << EOF
          ## éŠæˆ¯ç‹ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ é€±æ¬¡æ›´æ–°
          
          **æ›´æ–°æ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ### ğŸ“Š ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ
          - ã‚«ãƒ¼ãƒ‰åŸºæœ¬æƒ…å ±: $(wc -l < output/data/cards-all.tsv | xargs) è¡Œ
          - ã‚«ãƒ¼ãƒ‰è©³ç´°æƒ…å ±: $(wc -l < output/data/details-all.tsv | xargs) è¡Œ
          - FAQæƒ…å ±: $(wc -l < output/data/faq-all.tsv | xargs) è¡Œ
          
          ### ğŸ“¦ ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹
          - \`cards-all.tsv\`: ã‚«ãƒ¼ãƒ‰åŸºæœ¬æƒ…å ±ï¼ˆåå‰ã€ç¨®æ—ã€å±æ€§ã€æ”»æ’ƒåŠ›ç­‰ï¼‰
          - \`details-all.tsv\`: ã‚«ãƒ¼ãƒ‰è£œè¶³æƒ…å ±ï¼ˆãƒ«ãƒ¼ãƒ«è£œè¶³ã€ãƒšãƒ³ãƒ‡ãƒ¥ãƒ©ãƒ è£œè¶³ï¼‰
          - \`faq-all.tsv\`: FAQè©³ç´°ï¼ˆè³ªå•ãƒ»å›ç­”ãƒ»æ›´æ–°æ—¥ï¼‰
          
          ### ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          \`${ARCHIVE_NAME}\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦å±•é–‹ã—ã¦ãã ã•ã„ã€‚
          
          ### ğŸ“‹ ãƒ‡ãƒ¼ã‚¿å½¢å¼
          - ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°: UTF-8
          - åŒºåˆ‡ã‚Šæ–‡å­—: ã‚¿ãƒ–ï¼ˆTSVï¼‰
          - ã‚½ãƒ¼ãƒˆé †: IDé™é †ï¼ˆæ–°ã—ã„ã‚‚ã®ãŒå…ˆé ­ï¼‰
          EOF
          
          # æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ãŒã‚ã‚‹ã‹ç¢ºèª
          if gh release view "${RELEASE_TAG}" 2>/dev/null; then
            echo "æ—¢å­˜ã®ãƒªãƒªãƒ¼ã‚¹ã‚’æ›´æ–°ã—ã¾ã™: ${RELEASE_TAG}"
            # æ—¢å­˜ã®ã‚¢ã‚»ãƒƒãƒˆã‚’å‰Šé™¤
            gh release delete-asset "${RELEASE_TAG}" "ygo-data-${RELEASE_TAG}.tar.gz" 2>/dev/null || true
            # æ–°ã—ã„ã‚¢ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            gh release upload "${RELEASE_TAG}" "${ARCHIVE_NAME}"
          else
            echo "æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™: ${RELEASE_TAG}"
            # ãƒªãƒªãƒ¼ã‚¹ä½œæˆ
            gh release create "${RELEASE_TAG}" \
              "${ARCHIVE_NAME}" \
              --title "éŠæˆ¯ç‹ãƒ‡ãƒ¼ã‚¿ ${RELEASE_TAG}" \
              --notes-file release-notes.md
          fi

      - name: Keep only latest 3 releases
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "=== å¤ã„ãƒªãƒªãƒ¼ã‚¹ã‚’å‰Šé™¤ ==="
          
          # ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°ã‚’å–å¾—ï¼ˆæ–°ã—ã„é †ï¼‰
          RELEASES=$(gh release list --limit 100 --json tagName -q '.[].tagName')
          
          # é…åˆ—ã«å¤‰æ›
          readarray -t RELEASE_ARRAY <<< "$RELEASES"
          
          # ä»¶æ•°ç¢ºèª
          TOTAL=${#RELEASE_ARRAY[@]}
          echo "ç·ãƒªãƒªãƒ¼ã‚¹æ•°: ${TOTAL}"
          
          # 4ç•ªç›®ä»¥é™ã‚’å‰Šé™¤
          if [ ${TOTAL} -gt 3 ]; then
            echo "æœ€æ–°3ä»¶ã‚’ä¿æŒã—ã€æ®‹ã‚Šã‚’å‰Šé™¤ã—ã¾ã™"
            for i in $(seq 3 $((TOTAL-1))); do
              TAG="${RELEASE_ARRAY[$i]}"
              if [ -n "$TAG" ]; then
                echo "å‰Šé™¤ä¸­: ${TAG}"
                gh release delete "${TAG}" --yes --cleanup-tag || true
              fi
            done
          else
            echo "ãƒªãƒªãƒ¼ã‚¹æ•°ãŒ3ä»¶ä»¥ä¸‹ã®ãŸã‚ã€å‰Šé™¤ä¸è¦ã§ã™"
          fi

      - name: Summary
        run: |
          echo "## âœ… ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒªãƒªãƒ¼ã‚¹ã‚¿ã‚°**: ${RELEASE_TAG}" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–**: ${ARCHIVE_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚µã‚¤ã‚º**: $(ls -lh ${ARCHIVE_NAME} | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
